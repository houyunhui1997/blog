<!DOCTYPE html <head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
<title>致唐小姐</title>

<style type="text/css">
	@font-face {
		font-family: digit;
		src: url('digital-7_mono.ttf') format("truetype");
	}

	body {
		margin: 0;
		padding: 0;
		background: #ffe;
		font-size: 12px;
		overflow: auto
	}

	#mainDiv {
		width: 100%;
		height: 100%
	}

	#loveHeart {
		float: left;
		width: 670px;
		height: 625px
	}

	#garden {
		width: 100%;
		height: 100%
	}

	#elapseClock {
		text-align: right;
		font-size: 18px;
		margin-top: 10px;
		margin-bottom: 10px
	}

	#words {
		font-family: "sans-serif";
		width: 500px;
		font-size: 24px;
		color: #666
	}

	#messages {
		display: none
	}

	#elapseClock .digit {
		font-family: "digit";
		font-size: 36px
	}

	#loveu {
		padding: 5px;
		font-size: 22px;
		margin-top: 0px;
		margin-right: 120px;
		text-align: right;
		display: none
	}

	#loveu .signature {
		margin-top: 10px;
		font-size: 20px;
		font-style: italic
	}

	#clickSound {
		display: none
	}

	#code {
		float: left;
		width: 440px;
		height: 400px;
		color: #333;
		font-family: "Consolas", "Monaco", "Bitstream Vera Sans Mono", "Courier New", "sans-serif";
		font-size: 16px;
		line-height: 35px;
	}

	#code .string {
		color: #2a36ff
	}

	#code .keyword {
		color: #7f0055;
		font-weight: bold
	}

	#code .placeholder {
		margin-left: 15px
	}

	#code .space {
		margin-left: 7px
	}

	#code .comments {
		color: #3f7f5f
	}

	#copyright {
		margin-top: 10px;
		text-align: center;
		width: 100%;
		color: #666
	}

	#errorMsg {
		width: 100%;
		text-align: center;
		font-size: 24px;
		position: absolute;
		top: 100px;
		left: 0
	}

	#copyright a {
		color: #666
	}
</style>
</head>
<body>
	<div id="mainDiv">
		<div id="content">
			<div id="code">
				<span class="comments">人生至少该有一次</span><br />
				<span class="comments">为了某一个人而忘了自己</span><br />
				<span class="keyword">不求结果，不求同行，</span><br />
				<span class="keyword">不求曾经拥有，甚至不求你爱我，</span><br />
				<span class="keyword">只求在我最美的年华里</span><br />
				<span class="keyword">遇到你</span><br />
			</div>
			<div id="loveHeart">
				<canvas id="garden"></canvas>
				<div id="words">
					<div id="messages">
						亲爱的，这是我们相爱的时光。
						<div id="elapseClock"></div>
					</div>
					<div id="loveu">
						爱你的<br />
						<div class="signature">- 侯先生</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script>
	class Vector {
		constructor(x, y) {
			this.x = x;
			this.y = y;
		}

		rotate(theta) {
			const cos = Math.cos(theta), sin = Math.sin(theta);
			const x = this.x, y = this.y;
			this.x = cos * x - sin * y;
			this.y = sin * x + cos * y;
			return this;
		}

		mult(factor) {
			this.x *= factor;
			this.y *= factor;
			return this;
		}

		clone() {
			return new Vector(this.x, this.y);
		}

		length() {
			return Math.sqrt(this.x ** 2 + this.y ** 2);
		}

		subtract(v) {
			this.x -= v.x;
			this.y -= v.y;
			return this;
		}

		set(x, y) {
			this.x = x;
			this.y = y;
			return this;
		}
	}

	class Petal {
		constructor(stretchA, stretchB, startAngle, angle, growFactor, bloom) {
			this.stretchA = stretchA;
			this.stretchB = stretchB;
			this.startAngle = startAngle;
			this.angle = angle;
			this.growFactor = growFactor;
			this.bloom = bloom;
			this.r = 1;
			this.isFinished = false;
		}

		draw() {
			const ctx = this.bloom.garden.ctx;
			const radStart = Garden.degrad(this.startAngle);
			const radAngle = Garden.degrad(this.angle);

			const v1 = new Vector(0, this.r).rotate(radStart);
			const v2 = v1.clone().rotate(radAngle);
			const v3 = v1.clone().mult(this.stretchA);
			const v4 = v2.clone().mult(this.stretchB);

			ctx.strokeStyle = this.bloom.color;
			ctx.beginPath();
			ctx.moveTo(v1.x, v1.y);
			ctx.bezierCurveTo(v3.x, v3.y, v4.x, v4.y, v2.x, v2.y);
			ctx.stroke();
		}

		render() {
			if (this.r <= this.bloom.radius) {
				this.r += this.growFactor;
				this.draw();
			} else {
				this.isFinished = true;
			}
		}
	}

	class Bloom {
		constructor(position, radius, color, petalCount, garden) {
			this.position = position;
			this.radius = radius;
			this.color = color;
			this.petalCount = petalCount;
			this.garden = garden;
			this.petals = [];
			this.init();
			this.garden.addBloom(this);
		}

		init() {
			const angle = 360 / this.petalCount;
			const startAngle = Garden.randomInt(0, 90);
			for (let i = 0; i < this.petalCount; i++) {
				const petal = new Petal(
					Garden.random(Garden.options.petalStretch.min, Garden.options.petalStretch.max),
					Garden.random(Garden.options.petalStretch.min, Garden.options.petalStretch.max),
					startAngle + i * angle,
					angle,
					Garden.random(Garden.options.growFactor.min, Garden.options.growFactor.max),
					this
				);
				this.petals.push(petal);
			}
		}

		draw() {
			const ctx = this.garden.ctx;
			let allFinished = true;
			ctx.save();
			ctx.translate(this.position.x, this.position.y);
			for (const petal of this.petals) {
				petal.render();
				allFinished = allFinished && petal.isFinished;
			}
			ctx.restore();

			if (allFinished) {
				this.garden.removeBloom(this);
			}
		}
	}

	class Garden {
		constructor(ctx, canvas) {
			this.ctx = ctx;
			this.canvas = canvas;
			this.blooms = [];
		}

		render() {
			for (const bloom of this.blooms) {
				bloom.draw();
			}
		}

		addBloom(bloom) {
			this.blooms.push(bloom);
		}

		removeBloom(bloom) {
			const index = this.blooms.indexOf(bloom);
			if (index !== -1) {
				this.blooms.splice(index, 1);
			}
		}

		clear() {
			this.blooms = [];
			this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
		}

		createRandomBloom(x, y) {
			this.createBloom(
				x,
				y,
				Garden.randomInt(Garden.options.bloomRadius.min, Garden.options.bloomRadius.max),
				Garden.randomRGBA(),
				Garden.randomInt(Garden.options.petalCount.min, Garden.options.petalCount.max)
			);
		}

		createBloom(x, y, radius, color, petalCount) {
			new Bloom(new Vector(x, y), radius, color, petalCount, this);
		}

		static random(min, max) {
			return Math.random() * (max - min) + min;
		}

		static randomInt(min, max) {
			return Math.floor(Math.random() * (max - min + 1)) + min;
		}

		static degrad(deg) {
			return deg * Math.PI / 180;
		}

		static rgba(r, g, b, a) {
			return `rgba(${r},${g},${b},${a})`;
		}

		static randomRGBA() {
			const opt = Garden.options.color;
			let r, g, b, attempt = 5;
			do {
				r = Math.round(Garden.random(opt.rmin, opt.rmax));
				g = Math.round(Garden.random(opt.gmin, opt.gmax));
				b = Math.round(Garden.random(opt.bmin, opt.bmax));
			} while (--attempt && Math.abs(r - g) < 5 && Math.abs(g - b) < 5 && Math.abs(b - r) < 5);
			return Garden.rgba(r, g, b, opt.opacity);
		}
	}

	Garden.options = {
		petalCount: { min: 8, max: 15 },
		petalStretch: { min: 0.1, max: 3 },
		growFactor: { min: 0.1, max: 1 },
		bloomRadius: { min: 8, max: 10 },
		color: {
			rmin: 128, rmax: 255,
			gmin: 0, gmax: 128,
			bmin: 0, bmax: 128,
			opacity: 0.1
		}
	};

	let gardenCtx, gardenCanvas, garden;
	let clientWidth = window.innerWidth;
	let clientHeight = window.innerHeight;


	document.addEventListener("DOMContentLoaded", () => {
		let offsetX, offsetY;
		// 初始化 garden
		const loveHeart = document.getElementById("loveHeart");
		offsetX = loveHeart.offsetWidth / 2;
		offsetY = loveHeart.offsetHeight / 2 - 55;

		const gardenElement = document.getElementById("garden");
		gardenCanvas = gardenElement;
		gardenCanvas.width = loveHeart.offsetWidth;
		gardenCanvas.height = loveHeart.offsetHeight;
		gardenCtx = gardenCanvas.getContext("2d");
		gardenCtx.globalCompositeOperation = "lighter";
		garden = new Garden(gardenCtx, gardenCanvas);

		const content = document.getElementById("content");
		const code = document.getElementById("code");

		content.style.width = loveHeart.offsetWidth + code.offsetWidth + "px";
		content.style.height = Math.max(loveHeart.offsetHeight, code.offsetHeight) + "px";

		setInterval(() => {
			garden.render();
		}, Garden.options.growSpeed);
	});

	window.addEventListener("resize", () => {
		const newWidth = window.innerWidth;
		const newHeight = window.innerHeight;
		if (newWidth !== clientWidth && newHeight !== clientHeight) {
			location.reload();
		}
	});

	function getHeartPoint(angle) {
		const t = angle / Math.PI;
		const x = 19.5 * (16 * Math.pow(Math.sin(t), 3));
		const y = -20 * (13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t));
		return [offsetX + x, offsetY + y];
	}

	function startHeartAnimation() {
		const interval = 50;
		let angle = 10;
		const heart = [];
		const animationTimer = setInterval(() => {
			const bloom = getHeartPoint(angle);
			let draw = true;
			for (const p of heart) {
				const distance = Math.hypot(p[0] - bloom[0], p[1] - bloom[1]);
				if (distance < Garden.options.bloomRadius.max * 1.3) {
					draw = false;
					break;
				}
			}
			if (draw) {
				heart.push(bloom);
				garden.createRandomBloom(bloom[0], bloom[1]);
			}
			if (angle >= 30) {
				clearInterval(animationTimer);
				showMessages();
			} else {
				angle += 0.2;
			}
		}, interval);
	}

	function typewriter(element) {
		const str = element.innerHTML;
		element.innerHTML = '';
		let progress = 0;
		const timer = setInterval(() => {
			const current = str.charAt(progress);
			if (current === '<') {
				progress = str.indexOf('>', progress) + 1;
			} else {
				progress++;
			}
			element.innerHTML = str.substring(0, progress) + (progress % 2 === 1 ? '_' : '');
			if (progress >= str.length) {
				clearInterval(timer);
			}
		}, 75);
	}

	function timeElapse(date) {
		const current = new Date();
		const seconds = Math.floor((current - new Date(date)) / 1000);

		const days = Math.floor(seconds / (3600 * 24));
		let remaining = seconds % (3600 * 24);

		let hours = Math.floor(remaining / 3600);
		if (hours < 10) hours = "0" + hours;

		remaining %= 3600;
		let minutes = Math.floor(remaining / 60);
		if (minutes < 10) minutes = "0" + minutes;

		let secs = remaining % 60;
		if (secs < 10) secs = "0" + secs;

		const result = `
		<span class="digit">${days}</span> days
		<span class="digit">${hours}</span> hours
		<span class="digit">${minutes}</span> minutes
		<span class="digit">${secs}</span> seconds
	  `;
		document.getElementById("elapseClock").innerHTML = result;
	}

	function showMessages() {
		adjustWordsPosition();
		const messages = document.getElementById("messages");
		messages.style.display = "block";
		messages.style.opacity = 0;
		let opacity = 0;
		const fadeIn = setInterval(() => {
			opacity += 0.02;
			messages.style.opacity = opacity;
			if (opacity >= 1) {
				clearInterval(fadeIn);
				showLoveU();
			}
		}, 100);
	}

	function adjustWordsPosition() {
		const words = document.getElementById("words");
		const garden = document.getElementById("garden");
		words.style.position = "absolute";
		words.style.top = garden.offsetTop + 195 + "px";
		words.style.left = garden.offsetLeft + 70 + "px";
	}

	function adjustCodePosition() {
		const code = document.getElementById("code");
		const garden = document.getElementById("garden");
		code.style.marginTop = (garden.offsetHeight - code.offsetHeight) / 2 + "px";
	}

	function showLoveU() {
		const loveu = document.getElementById("loveu");
		loveu.style.display = "block";
		loveu.style.opacity = 0;
		let opacity = 0;
		const fadeIn = setInterval(() => {
			opacity += 0.02;
			loveu.style.opacity = opacity;
			if (opacity >= 1) {
				clearInterval(fadeIn);
			}
		}, 60);
	}

	// 获取 loveHeart 宽高中心点
	const loveHeart = document.getElementById("loveHeart");
	const offsetX = loveHeart.offsetWidth / 2;
	const offsetY = loveHeart.offsetHeight / 2 - 55;

	// 设置纪念日时间：2025年03月03日 22:38:00
	const together = new Date("2025/04/05 21:00:00");

	// 判断是否支持 canvas
	if (!document.createElement("canvas").getContext) {
		const msg = document.createElement("div");
		msg.id = "errorMsg";
		msg.innerHTML = "Your browser doesn't support HTML5!<br/>Recommend use Chrome 14+/IE 9+/Firefox 7+/Safari 4+";
		document.body.appendChild(msg);

		const code = document.getElementById("code");
		if (code) code.style.display = "none";

		const copyright = document.getElementById("copyright");
		if (copyright) {
			copyright.style.position = "absolute";
			copyright.style.bottom = "10px";
		}

		try {
			document.execCommand("Stop");
		} catch (e) {
			// 某些浏览器可能不支持 execCommand("Stop")
			console.warn("Stop command not supported");
		}
	} else {
		// 支持 Canvas 的情况
		setTimeout(() => {
			startHeartAnimation();
		}, 5000);

		timeElapse(together);
		setInterval(() => {
			timeElapse(together);
		}, 500);

		adjustCodePosition();

		const codeElement = document.getElementById("code");
		if (codeElement) typewriter(codeElement);
	}
</script>
</html>